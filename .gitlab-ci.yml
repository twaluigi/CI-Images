image: docker:latest

services:
  - docker:dind

stages:
  - build

awscli:
  variables:
    PYTHON_VERSION: "3.7.4"
    AWSCLI_VERSION: "1.16.218"
  stage: build
  before_script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
  script:
    - docker build --build-arg PYTHON_VERSION=${PYTHON_VERSION} --build-arg AWSCLI_VERSION=${AWSCLI_VERSION} -t $CI_REGISTRY/twaluigi/ci-images/awscli:${AWSCLI_VERSION} awscli/
    - docker build --build-arg PYTHON_VERSION=${PYTHON_VERSION} --build-arg AWSCLI_VERSION=${AWSCLI_VERSION} -t $CI_REGISTRY/twaluigi/ci-images/awscli:latest awscli/
    - docker push $CI_REGISTRY/twaluigi/ci-images/awscli:${AWSCLI_VERSION}
    - docker push $CI_REGISTRY/twaluigi/ci-images/awscli:latest

hugo:
  variables:
    ALPINE_VERSION: "3.10"
    HUGO_VERSION: "0.56.3"
  stage: build
  before_script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
  script:
    - docker build --build-arg ALPINE_VERSION=${ALPINE_VERSION} --build-arg HUGO_VERSION=${HUGO_VERSION} -t $CI_REGISTRY/twaluigi/ci-images/hugo:${HUGO_VERSION} hugo/
    - docker build --build-arg ALPINE_VERSION=${ALPINE_VERSION} --build-arg HUGO_VERSION=${HUGO_VERSION} -t $CI_REGISTRY/twaluigi/ci-images/hugo:latest hugo/
    - docker push $CI_REGISTRY/twaluigi/ci-images/hugo:${HUGO_VERSION}
    - docker push $CI_REGISTRY/twaluigi/ci-images/hugo:latest

terragrunt:
  variables:
    TERRAFORM_VERSION: "0.12.6"
    TERRAGRUNT_VERSION: "0.19.19"
    TERRAGRUNT_TFPATH: "/bin/terraform"
  stage: build
  before_script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
  script:
    - docker build --build-arg ALPINE_VERSION=${ALPINE_VERSION} --build-arg TERRAFORM_VERSION=${TERRAFORM_VERSION} --build-arg TERRAGRUNT_VERSION=${TERRAGRUNT_VERSION} --build-arg TERRAGRUNT_TFPATH=${TERRAGRUNT_TFPATH} -t $CI_REGISTRY/twaluigi/ci-images/terragrunt:${TERRAGRUNT_VERSION} terragrunt/
    - docker build --build-arg ALPINE_VERSION=${ALPINE_VERSION} --build-arg TERRAFORM_VERSION=${TERRAFORM_VERSION} --build-arg TERRAGRUNT_VERSION=${TERRAGRUNT_VERSION} --build-arg TERRAGRUNT_TFPATH=${TERRAGRUNT_TFPATH} -t $CI_REGISTRY/twaluigi/ci-images/terragrunt:latest terragrunt/
    - docker push $CI_REGISTRY/twaluigi/ci-images/terragrunt:${TERRAGRUNT_VERSION}
    - docker push $CI_REGISTRY/twaluigi/ci-images/terragrunt:latest